<html>
<body>
<p>Comet, yah!</p>
<form id="sendForm" action="send" method="get" onsubmit="retrun false;">
   Message: <input type="text" name="msg" id="msg">
   <input type="submit" name="send" value="Send">
</form>
<div id="writer"></div>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/mootools/1.3.2/mootools-yui-compressed.js"></script>
<script type="text/javascript">
var req;
function startstream() {
    req = new Request({
      url: "/server_push?" + Math.floor(Math.random() * 1024)
    });
    req.send();
}

function setClientId(id) {
   window.clientId = id;
}

var lastmsglength = 0;
window.addEvent('domready', function () {
    startstream();
    $('sendForm').addEvent('submit', function (evt) {
      this.send();
    });
    (function () {
       var content = req.xhr.responseText.substr(lastmsglength, req.xhr.responseText.length);
       //console.log(content);
       lastmsglength = req.xhr.responseText.length;
       if (content.indexOf("script") > -1) {
         var parts = content.split("<script type=\"text/javascript\">");
         for (var i = 0; i < parts.length; i++) {
            var part = parts[i];
            if (part.indexOf ('<\/script>') > -1) {
               var js = part.split("</" + "script>").shift();
               eval(js);
            }
         }
       } else {
         //-- Did the connection die?
       }
    }).periodical(1000);
});
</script>
</body>
</html>
